{% extends "base.html" %}

{% block title %}Security Tools - Syn_OS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white flex items-center">
                <i class="fas fa-tools text-blue-400 mr-3"></i>
                Security Tools
            </h1>
            <p class="text-slate-400 mt-1">Integrated security scanning and penetration testing tools</p>
        </div>
        <div class="flex items-center space-x-4">
            <button onclick="showScanHistory()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200">
                <i class="fas fa-history mr-2"></i>Scan History
            </button>
        </div>
    </div>

    <!-- Tool Categories -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Network Scanning -->
        <div class="security-card p-6">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-network-wired text-white text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white">Network Scanning</h3>
                    <p class="text-sm text-slate-400">Port and service discovery</p>
                </div>
            </div>
            <div class="space-y-3">
                <button onclick="showNmapInterface()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200 text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Nmap Scanner</div>
                            <div class="text-sm opacity-75">Network discovery and security auditing</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </button>
                <button onclick="showMasscanInterface()" class="w-full bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition duration-200 text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Masscan</div>
                            <div class="text-sm opacity-75">High-speed port scanner</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </button>
            </div>
        </div>

        <!-- Vulnerability Assessment -->
        <div class="security-card p-6">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-12 h-12 bg-red-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-bug text-white text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white">Vulnerability Assessment</h3>
                    <p class="text-sm text-slate-400">Security weakness detection</p>
                </div>
            </div>
            <div class="space-y-3">
                <button onclick="showMetasploitInterface()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200 text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Metasploit Framework</div>
                            <div class="text-sm opacity-75">Penetration testing platform</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </button>
                <button onclick="showOpenVASInterface()" class="w-full bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition duration-200 text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">OpenVAS</div>
                            <div class="text-sm opacity-75">Vulnerability scanner</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </button>
            </div>
        </div>

        <!-- Web Application Testing -->
        <div class="security-card p-6">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-globe text-white text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white">Web Application</h3>
                    <p class="text-sm text-slate-400">Web security testing</p>
                </div>
            </div>
            <div class="space-y-3">
                <button onclick="showBurpInterface()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200 text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Burp Suite</div>
                            <div class="text-sm opacity-75">Web application security testing</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </button>
                <button onclick="showOWASPZAPInterface()" class="w-full bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition duration-200 text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">OWASP ZAP</div>
                            <div class="text-sm opacity-75">Web application scanner</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Active Scans -->
    <div class="security-card p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Active Scans</h3>
            <span class="bg-blue-900 text-blue-200 px-2 py-1 rounded text-sm" id="activeScanCount">0 Running</span>
        </div>
        <div id="activeScansContainer" class="space-y-3">
            <div class="text-center py-8 text-slate-400">
                <i class="fas fa-search text-4xl mb-4"></i>
                <p>No active scans</p>
                <p class="text-sm">Start a scan using the tools above</p>
            </div>
        </div>
    </div>

    <!-- Recent Scan Results -->
    <div class="security-card p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Recent Scan Results</h3>
            <button onclick="exportResults()" class="text-blue-400 hover:text-blue-300 text-sm">
                <i class="fas fa-download mr-1"></i>Export
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-slate-600">
                        <th class="text-left py-3 px-4 text-slate-300">Tool</th>
                        <th class="text-left py-3 px-4 text-slate-300">Target</th>
                        <th class="text-left py-3 px-4 text-slate-300">Type</th>
                        <th class="text-left py-3 px-4 text-slate-300">Status</th>
                        <th class="text-left py-3 px-4 text-slate-300">Threat Level</th>
                        <th class="text-left py-3 px-4 text-slate-300">Date</th>
                        <th class="text-left py-3 px-4 text-slate-300">Actions</th>
                    </tr>
                </thead>
                <tbody id="scanResultsTable">
                    {% for scan in scan_history %}
                    <tr class="border-b border-slate-700 hover:bg-slate-700">
                        <td class="py-3 px-4 text-white">{{ scan.tool_name }}</td>
                        <td class="py-3 px-4 text-slate-300">{{ scan.target }}</td>
                        <td class="py-3 px-4 text-slate-300">{{ scan.scan_type }}</td>
                        <td class="py-3 px-4">
                            <span class="bg-green-900 text-green-200 px-2 py-1 rounded text-xs">Completed</span>
                        </td>
                        <td class="py-3 px-4">
                            <span class="threat-level-{{ scan.threat_level.lower() }} font-medium">{{ scan.threat_level }}</span>
                        </td>
                        <td class="py-3 px-4 text-slate-300">{{ scan.timestamp }}</td>
                        <td class="py-3 px-4">
                            <button onclick="viewScanDetails('{{ scan.scan_id }}')" class="text-blue-400 hover:text-blue-300 mr-2">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="downloadScanReport('{{ scan.scan_id }}')" class="text-green-400 hover:text-green-300">
                                <i class="fas fa-download"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="py-8 text-center text-slate-400">
                            No scan results available
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Nmap Scan Modal -->
<div id="nmapModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-slate-800 p-6 rounded-lg max-w-2xl w-full mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Nmap Network Scanner</h3>
            <button onclick="closeModal('nmapModal')" class="text-slate-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="nmapForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Target</label>
                <input type="text" id="nmapTarget" placeholder="192.168.1.1 or example.com" 
                       class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Port Range</label>
                <input type="text" id="nmapPorts" placeholder="1-1000" value="1-1000"
                       class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Scan Type</label>
                <select id="nmapScanType" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="syn">SYN Scan (-sS)</option>
                    <option value="tcp">TCP Connect (-sT)</option>
                    <option value="udp">UDP Scan (-sU)</option>
                    <option value="comprehensive">Comprehensive (-sS -sV -O)</option>
                </select>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                    <i class="fas fa-play mr-2"></i>Start Scan
                </button>
                <button type="button" onclick="closeModal('nmapModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Metasploit Scan Modal -->
<div id="metasploitModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-slate-800 p-6 rounded-lg max-w-2xl w-full mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Metasploit Framework</h3>
            <button onclick="closeModal('metasploitModal')" class="text-slate-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="metasploitForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Target</label>
                <input type="text" id="metasploitTarget" placeholder="192.168.1.1" 
                       class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-red-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Scan Type</label>
                <select id="metasploitScanType" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-red-500">
                    <option value="vulnerability">Vulnerability Scan</option>
                    <option value="auxiliary">Auxiliary Modules</option>
                    <option value="discovery">Service Discovery</option>
                </select>
            </div>
            <div class="p-4 bg-yellow-900 border border-yellow-700 rounded-lg">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mt-1"></i>
                    <div class="text-sm text-yellow-200">
                        <p class="font-medium mb-1">Warning</p>
                        <p>Only use against systems you own or have explicit permission to test.</p>
                    </div>
                </div>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition duration-200">
                    <i class="fas fa-play mr-2"></i>Start Scan
                </button>
                <button type="button" onclick="closeModal('metasploitModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let activeScans = [];

// Modal functions
function showNmapInterface() {
    document.getElementById('nmapModal').classList.remove('hidden');
}

function showMetasploitInterface() {
    document.getElementById('metasploitModal').classList.remove('hidden');
}

function showMasscanInterface() {
    showNotification('Masscan interface coming soon', 'info');
}

function showBurpInterface() {
    showNotification('Burp Suite integration coming soon', 'info');
}

function showOWASPZAPInterface() {
    showNotification('OWASP ZAP integration coming soon', 'info');
}

function showOpenVASInterface() {
    showNotification('OpenVAS integration coming soon', 'info');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

// Scan functions
document.getElementById('nmapForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const target = document.getElementById('nmapTarget').value;
    const ports = document.getElementById('nmapPorts').value;
    const scanType = document.getElementById('nmapScanType').value;
    
    if (!target) {
        showNotification('Please enter a target', 'error');
        return;
    }
    
    try {
        showNotification('Starting Nmap scan...', 'info');
        closeModal('nmapModal');
        
        const response = await apiCall('/api/tools/nmap/scan', {
            method: 'POST',
            body: JSON.stringify({
                target: target,
                ports: ports,
                scan_type: scanType
            })
        });
        
        if (response.status === 'success') {
            showNotification('Nmap scan started successfully', 'success');
            addActiveScan('nmap', target, response.scan_id);
            
            // Simulate scan completion after 30 seconds
            setTimeout(() => {
                completeScan(response.scan_id, response.data);
            }, 30000);
        }
    } catch (error) {
        console.error('Nmap scan failed:', error);
        showNotification('Nmap scan failed', 'error');
    }
});

document.getElementById('metasploitForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const target = document.getElementById('metasploitTarget').value;
    const scanType = document.getElementById('metasploitScanType').value;
    
    if (!target) {
        showNotification('Please enter a target', 'error');
        return;
    }
    
    try {
        showNotification('Starting Metasploit scan...', 'info');
        closeModal('metasploitModal');
        
        const response = await apiCall('/api/tools/metasploit/scan', {
            method: 'POST',
            body: JSON.stringify({
                target: target,
                scan_type: scanType
            })
        });
        
        if (response.status === 'success') {
            showNotification('Metasploit scan started successfully', 'success');
            addActiveScan('metasploit', target, response.scan_id);
            
            // Simulate scan completion after 45 seconds
            setTimeout(() => {
                completeScan(response.scan_id, response.data);
            }, 45000);
        }
    } catch (error) {
        console.error('Metasploit scan failed:', error);
        showNotification('Metasploit scan failed', 'error');
    }
});

function addActiveScan(tool, target, scanId) {
    const scan = {
        id: scanId,
        tool: tool,
        target: target,
        startTime: new Date(),
        status: 'running'
    };
    
    activeScans.push(scan);
    updateActiveScansDisplay();
}

function completeScan(scanId, results) {
    const scanIndex = activeScans.findIndex(scan => scan.id === scanId);
    if (scanIndex !== -1) {
        activeScans[scanIndex].status = 'completed';
        activeScans[scanIndex].results = results;
        
        showNotification(`Scan ${scanId} completed`, 'success');
        updateActiveScansDisplay();
        
        // Add to results table
        addScanResult(activeScans[scanIndex]);
        
        // Remove from active scans after 5 seconds
        setTimeout(() => {
            activeScans.splice(scanIndex, 1);
            updateActiveScansDisplay();
        }, 5000);
    }
}

function updateActiveScansDisplay() {
    const container = document.getElementById('activeScansContainer');
    const countElement = document.getElementById('activeScanCount');
    
    countElement.textContent = `${activeScans.length} Running`;
    
    if (activeScans.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-slate-400">
                <i class="fas fa-search text-4xl mb-4"></i>
                <p>No active scans</p>
                <p class="text-sm">Start a scan using the tools above</p>
            </div>
        `;
    } else {
        container.innerHTML = activeScans.map(scan => `
            <div class="flex items-center justify-between p-4 bg-slate-700 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin text-white text-sm"></i>
                    </div>
                    <div>
                        <div class="text-white font-medium">${scan.tool.toUpperCase()} - ${scan.target}</div>
                        <div class="text-sm text-slate-400">Started: ${scan.startTime.toLocaleTimeString()}</div>
                    </div>
                </div>
                <div class="text-sm">
                    <span class="bg-blue-900 text-blue-200 px-2 py-1 rounded">${scan.status}</span>
                </div>
            </div>
        `).join('');
    }
}

function addScanResult(scan) {
    const table = document.getElementById('scanResultsTable');
    const row = document.createElement('tr');
    row.className = 'border-b border-slate-700 hover:bg-slate-700';
    row.innerHTML = `
        <td class="py-3 px-4 text-white">${scan.tool}</td>
        <td class="py-3 px-4 text-slate-300">${scan.target}</td>
        <td class="py-3 px-4 text-slate-300">Security Scan</td>
        <td class="py-3 px-4">
            <span class="bg-green-900 text-green-200 px-2 py-1 rounded text-xs">Completed</span>
        </td>
        <td class="py-3 px-4">
            <span class="threat-level-${scan.results?.threat_level?.toLowerCase() || 'low'} font-medium">${scan.results?.threat_level || 'LOW'}</span>
        </td>
        <td class="py-3 px-4 text-slate-300">${scan.startTime.toLocaleString()}</td>
        <td class="py-3 px-4">
            <button onclick="viewScanDetails('${scan.id}')" class="text-blue-400 hover:text-blue-300 mr-2">
                <i class="fas fa-eye"></i>
            </button>
            <button onclick="downloadScanReport('${scan.id}')" class="text-green-400 hover:text-green-300">
                <i class="fas fa-download"></i>
            </button>
        </td>
    `;
    
    // Insert at the beginning of the table
    if (table.children.length > 0 && table.children[0].children.length === 1) {
        // Remove "no results" row
        table.innerHTML = '';
    }
    table.insertBefore(row, table.firstChild);
}

function viewScanDetails(scanId) {
    // Create modal to show scan details
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-slate-800 p-6 rounded-lg max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">Scan Results - ${scanId}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="p-4 bg-slate-700 rounded-lg">
                    <h4 class="text-white font-medium mb-2">Summary</h4>
                    <p class="text-slate-300 text-sm">Scan completed successfully. Detailed results would be displayed here.</p>
                </div>
                <div class="p-4 bg-slate-700 rounded-lg">
                    <h4 class="text-white font-medium mb-2">Findings</h4>
                    <ul class="text-sm text-slate-300 space-y-1">
                        <li>• Open ports detected: 22, 80, 443</li>
                        <li>• Services identified: SSH, HTTP, HTTPS</li>
                        <li>• No critical vulnerabilities found</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function downloadScanReport(scanId) {
    showNotification(`Downloading report for scan ${scanId}`, 'info');
    // In a real implementation, this would download the actual report
}

function showScanHistory() {
    showNotification('Scan history feature coming soon', 'info');
}

function exportResults() {
    showNotification('Export functionality coming soon', 'info');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateActiveScansDisplay();
});
</script>
{% endblock %}