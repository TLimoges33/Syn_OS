name: Codespaces Prebuilds

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '.devcontainer/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - 'Cargo.toml'
      - 'package.json'
      - 'go.mod'
  pull_request:
    branches:
      - main
    paths:
      - '.devcontainer/**'
  schedule:
    # Rebuild prebuilds weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  prebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@v2
      with:
        egress-policy: audit
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          registry.npmjs.org:443
          crates.io:443
          static.rust-lang.org:443
          forge.rust-lang.org:443
          
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Security scan devcontainer
      run: |
        # Check for security issues in devcontainer configuration
        echo "🔍 Scanning devcontainer for security issues..."
        
        # Check for privileged container usage
        if grep -q '"privileged": true' .devcontainer/devcontainer.json; then
          echo "❌ ERROR: Privileged container detected"
          exit 1
        fi
        
        # Check for root user usage
        if grep -q '"remoteUser": "root"' .devcontainer/devcontainer.json; then
          echo "❌ ERROR: Root user detected in devcontainer"
          exit 1
        fi
        
        # Validate security options
        if ! grep -q "no-new-privileges" .devcontainer/devcontainer.json; then
          echo "⚠️  WARNING: no-new-privileges not set"
        fi
        
        echo "✅ Devcontainer security scan completed"
        
    - name: Validate Dockerfile security
      run: |
        echo "🔍 Scanning Dockerfile for security best practices..."
        
        # Check for root user
        if grep -q "USER root" .devcontainer/Dockerfile; then
          echo "❌ ERROR: Root user detected in Dockerfile"
          exit 1
        fi
        
        # Check for package verification
        if ! grep -q "sha256sum" .devcontainer/Dockerfile; then
          echo "⚠️  WARNING: Package verification not detected"
        fi
        
        # Check for security updates
        if ! grep -q "apt-get update" .devcontainer/Dockerfile; then
          echo "⚠️  WARNING: System updates not detected"
        fi
        
        echo "✅ Dockerfile security validation completed"
        
    - name: Log prebuild trigger
      run: |
        echo "📊 Prebuild triggered by: ${{ github.event_name }}"
        echo "📅 Timestamp: $(date -u)"
        echo "🔗 Commit: ${{ github.sha }}"
        echo "👤 Actor: ${{ github.actor }}"
        
        # Log to security audit trail
        echo "$(date -u): Prebuild triggered by ${{ github.actor }} via ${{ github.event_name }}" >> .security-audit.log