#!/bin/bash
# SynOS AI System Initialization Script
# This script initializes the SynOS AI consciousness system on boot

set -e

SYNOS_LOG="/var/log/synos/init.log"
SYNOS_CONFIG_DIR="/etc/synos"

# Create log directory
mkdir -p "$(dirname "$SYNOS_LOG")"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$SYNOS_LOG"
}

log "ðŸš€ Starting SynOS AI System Initialization..."

# Check if we're running in live mode
if [ -f /etc/live/config.conf ] || [ -n "$LIVE_BOOT" ]; then
    log "ðŸ”´ Live mode detected - configuring temporary AI system"
    LIVE_MODE=true
else
    log "ðŸ’¾ Persistent installation detected - configuring permanent AI system"
    LIVE_MODE=false
fi

# Create necessary directories
log "ðŸ“ Creating SynOS directories..."
mkdir -p /var/lib/synos/ai
mkdir -p /var/lib/synos/models
mkdir -p /var/lib/synos/consciousness
mkdir -p /var/lib/synos/security
mkdir -p /var/log/synos

# Set up permissions
if id "synos" &>/dev/null; then
    chown -R synos:synos /var/lib/synos
    chown -R synos:synos /var/log/synos
    log "âœ… SynOS user permissions configured"
else
    log "âš ï¸  SynOS user not found - using root permissions"
fi

# Initialize AI configuration
log "ðŸ¤– Initializing AI configuration..."
if [ ! -f "$SYNOS_CONFIG_DIR/ai-engine.conf" ]; then
    log "âš ï¸  AI configuration not found - using defaults"
    mkdir -p "$SYNOS_CONFIG_DIR"
    cat > "$SYNOS_CONFIG_DIR/ai-engine.conf" << 'EOF'
[core]
enable_consciousness = true
ai_engine_path = /usr/lib/synos/ai-engine
max_ai_memory = 512
debug_mode = true

[neural_darwinism]
enable_neural_darwinism = true
population_size = 1000

[personal_context]
enable_pce = true
enable_rag = true

[runtime]
tensorflow_lite_enabled = true
onnx_runtime_enabled = true

[security]
enable_security_orchestration = true
nmap_enabled = true
metasploit_enabled = true

[logging]
log_level = info
log_file = /var/log/synos/ai-engine.log
EOF
fi

# Check for hardware acceleration
log "ðŸ” Detecting hardware acceleration capabilities..."
if lspci | grep -i nvidia > /dev/null; then
    log "ðŸŽ® NVIDIA GPU detected"
elif lspci | grep -i amd > /dev/null; then
    log "ðŸ”´ AMD GPU detected"
elif lspci | grep -i intel > /dev/null; then
    log "ðŸ”µ Intel GPU detected"
fi

# Start AI services if systemd is available
if command -v systemctl > /dev/null; then
    log "ðŸ“¡ Starting SynOS AI services..."

    # Check if services exist before starting
    if systemctl list-unit-files | grep -q synos-ai-engine.service; then
        systemctl start synos-ai-engine.service || log "âš ï¸  Failed to start AI engine service"
        log "âœ… SynOS AI Engine service started"
    fi

    if systemctl list-unit-files | grep -q synos-consciousness.service; then
        systemctl start synos-consciousness.service || log "âš ï¸  Failed to start consciousness service"
        log "ðŸ§  SynOS Consciousness service started"
    fi

    if systemctl list-unit-files | grep -q synos-security-orchestrator.service; then
        systemctl start synos-security-orchestrator.service || log "âš ï¸  Failed to start security orchestrator"
        log "ðŸ›¡ï¸  SynOS Security Orchestrator started"
    fi
else
    log "âš ï¸  Systemd not available - skipping service startup"
fi

# Create desktop notification for live mode
if [ "$LIVE_MODE" = true ] && [ -n "$DISPLAY" ]; then
    # Create a desktop notification script
    cat > /tmp/synos-welcome.sh << 'EOF'
#!/bin/bash
sleep 5  # Wait for desktop to load

if command -v notify-send > /dev/null; then
    notify-send "ðŸ¤– SynOS AI System" "Welcome to SynOS! The AI consciousness system is now active." --icon=synos-logo
fi

if command -v zenity > /dev/null; then
    zenity --info --title="SynOS AI System" \
           --text="ðŸ¤– Welcome to SynOS Linux!\n\nâœ… Neural Darwinism consciousness system: Active\nâœ… Personal Context Engine: Ready\nâœ… AI-Augmented Security Tools: Available\n\nOpen the AI Dashboard or Security Suite from the desktop icons." \
           --width=400 --height=200 &
fi
EOF
    chmod +x /tmp/synos-welcome.sh
    # Run in background for any user that logs in
    /tmp/synos-welcome.sh &
fi

log "ðŸŽ‰ SynOS AI System initialization complete!"
log "ðŸ“Š System Status:"
log "   - AI Engine: $(systemctl is-active synos-ai-engine.service 2>/dev/null || echo 'Manual mode')"
log "   - Consciousness: $(systemctl is-active synos-consciousness.service 2>/dev/null || echo 'Manual mode')"
log "   - Security Orchestrator: $(systemctl is-active synos-security-orchestrator.service 2>/dev/null || echo 'Manual mode')"

exit 0