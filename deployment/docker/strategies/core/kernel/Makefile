# SynOS AI-Enhanced Kernel Components Build System
# Comprehensive build system for all AI kernel modules and components

# Module definitions
CONSCIOUSNESS_MODULE = synos_consciousness
AI_SCHEDULER_MODULE = ai_process_scheduler
AI_MEMORY_MODULE = ai_memory_manager
AI_IO_MODULE = ai_io_optimizer

# All kernel modules
MODULES = $(CONSCIOUSNESS_MODULE) $(AI_SCHEDULER_MODULE) $(AI_MEMORY_MODULE) $(AI_IO_MODULE)

# Object files
obj-m += $(CONSCIOUSNESS_MODULE).o
obj-m += $(AI_SCHEDULER_MODULE).o
obj-m += $(AI_MEMORY_MODULE).o
obj-m += $(AI_IO_MODULE).o

# Kernel build directory
KERNEL_DIR ?= /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

# Build flags
ccflags-y := -DSYNOS_AI_KERNEL \
             -DSYNOS_VERSION=\"1.0.0\" \
             -DDEBUG \
             -O2 \
             -Wall \
             -Wextra \
             -std=gnu99

# eBPF subdirectory
EBPF_DIR = ebpf

.PHONY: all clean install load unload test status help modules ebpf full-build deploy

# Default target
all: banner modules ebpf
	@echo "âœ… SynOS AI-Enhanced Kernel build complete!"

# Display banner
banner:
	@echo "ğŸ§  ======================================================= ğŸ§ "
	@echo "ğŸš€               SynOS AI-Enhanced Kernel               ğŸš€"
	@echo "ğŸ“              Neural Darwinism OS v1.0.0              ğŸ“"
	@echo "ğŸ§  ======================================================= ğŸ§ "
	@echo ""
	@echo "Building components:"
	@echo "  ğŸ§  AI-Native Process Scheduler"
	@echo "  ğŸ§  Adaptive Memory Management"
	@echo "  ğŸ§  AI-Powered I/O Optimization"
	@echo "  ğŸ§  Consciousness Monitoring System"
	@echo "  ğŸ›¡ï¸ eBPF Security Framework"
	@echo ""

# Build all kernel modules
modules:
	@echo "ğŸ”¨ Building SynOS AI kernel modules..."
	make -C $(KERNEL_DIR) M=$(PWD) modules
	@echo "âœ… Kernel modules built successfully!"

# Build eBPF programs
ebpf:
	@echo "ğŸ›¡ï¸ Building eBPF security programs..."
	$(MAKE) -C $(EBPF_DIR) all
	@echo "âœ… eBPF programs built successfully!"

# Clean all build artifacts
clean:
	@echo "ğŸ§¹ Cleaning SynOS AI kernel build artifacts..."
	make -C $(KERNEL_DIR) M=$(PWD) clean
	$(MAKE) -C $(EBPF_DIR) clean
	rm -f *.symvers *.order *.mod.c .*.cmd
	rm -rf .tmp_versions/
	@echo "âœ… Clean complete!"

# Install all modules
install: modules ebpf
	@echo "ğŸ“¦ Installing SynOS AI kernel modules..."
	sudo make -C $(KERNEL_DIR) M=$(PWD) modules_install
	sudo depmod -a
	$(MAKE) -C $(EBPF_DIR) install
	@echo "âœ… Installation complete!"

# Load all modules in correct order
load: install
	@echo "ğŸš€ Loading SynOS AI kernel modules..."
	@echo "ğŸ“‹ Loading modules in dependency order..."

	@echo "ğŸ§  Loading consciousness monitoring..."
	sudo modprobe $(CONSCIOUSNESS_MODULE) || echo "âš ï¸ Consciousness module load failed"

	@echo "ğŸ§  Loading AI process scheduler..."
	sudo modprobe $(AI_SCHEDULER_MODULE) || echo "âš ï¸ AI scheduler module load failed"

	@echo "ğŸ§  Loading AI memory manager..."
	sudo modprobe $(AI_MEMORY_MODULE) || echo "âš ï¸ AI memory module load failed"

	@echo "ğŸ§  Loading AI I/O optimizer..."
	sudo modprobe $(AI_IO_MODULE) || echo "âš ï¸ AI I/O module load failed"

	@echo "ğŸ›¡ï¸ Loading eBPF programs..."
	$(MAKE) -C $(EBPF_DIR) load || echo "âš ï¸ eBPF programs load failed"

	@echo "âœ… All SynOS AI modules loaded successfully!"
	@$(MAKE) status

# Unload all modules
unload:
	@echo "ğŸ›‘ Unloading SynOS AI kernel modules..."

	@echo "ğŸ›¡ï¸ Unloading eBPF programs..."
	$(MAKE) -C $(EBPF_DIR) unload || echo "â„¹ï¸ eBPF programs were not loaded"

	@echo "ğŸ§  Unloading AI modules in reverse order..."
	sudo rmmod $(AI_IO_MODULE) 2>/dev/null || echo "â„¹ï¸ AI I/O module was not loaded"
	sudo rmmod $(AI_MEMORY_MODULE) 2>/dev/null || echo "â„¹ï¸ AI memory module was not loaded"
	sudo rmmod $(AI_SCHEDULER_MODULE) 2>/dev/null || echo "â„¹ï¸ AI scheduler module was not loaded"
	sudo rmmod $(CONSCIOUSNESS_MODULE) 2>/dev/null || echo "â„¹ï¸ Consciousness module was not loaded"

	@echo "âœ… All modules unloaded!"

# Remove all modules from system
remove: unload
	@echo "ğŸ—‘ï¸ Removing SynOS AI kernel modules from system..."
	@for module in $(MODULES); do \
		sudo rm -f /lib/modules/$(shell uname -r)/extra/$$module.ko; \
	done
	$(MAKE) -C $(EBPF_DIR) clean
	sudo depmod -a
	@echo "âœ… All modules removed from system!"

# Run comprehensive tests
test: load
	@echo "ğŸ§ª Running SynOS AI kernel module tests..."
	@echo ""
	@echo "ğŸ“‹ Testing consciousness monitoring..."
	@ls -la /dev/synos 2>/dev/null && echo "âœ… Consciousness device file exists" || echo "âŒ Consciousness device missing"
	@cat /proc/synos_consciousness 2>/dev/null | head -5 || echo "âŒ Consciousness proc entry not accessible"

	@echo ""
	@echo "ğŸ“‹ Testing AI scheduler..."
	@cat /proc/synos_ai_scheduler 2>/dev/null | head -5 || echo "âŒ AI scheduler proc entry not accessible"

	@echo ""
	@echo "ğŸ“‹ Testing AI memory manager..."
	@cat /proc/synos_ai_memory 2>/dev/null | head -5 || echo "âŒ AI memory proc entry not accessible"

	@echo ""
	@echo "ğŸ“‹ Testing AI I/O optimizer..."
	@cat /proc/synos_ai_io 2>/dev/null | head -5 || echo "âŒ AI I/O proc entry not accessible"

	@echo ""
	@echo "ğŸ“‹ Testing eBPF programs..."
	$(MAKE) -C $(EBPF_DIR) status

	@echo ""
	@echo "ğŸ“‹ Checking kernel messages..."
	@dmesg | tail -20 | grep -i synos || echo "â„¹ï¸ No recent SynOS messages in dmesg"

	@echo ""
	@echo "ğŸ§ª Basic functionality test complete!"

# Show comprehensive status
status:
	@echo "ğŸ“Š SynOS AI-Enhanced Kernel Status Report"
	@echo "=========================================="
	@echo ""
	@echo "ğŸ” Kernel Modules Status:"
	@for module in $(MODULES); do \
		if lsmod | grep -q $$module; then \
			echo "  âœ… $$module: LOADED"; \
		else \
			echo "  âŒ $$module: NOT LOADED"; \
		fi; \
	done

	@echo ""
	@echo "ğŸ” Device Files:"
	@ls -la /dev/synos 2>/dev/null && echo "  âœ… /dev/synos: EXISTS" || echo "  âŒ /dev/synos: MISSING"

	@echo ""
	@echo "ğŸ” Proc Interfaces:"
	@ls -la /proc/synos_* 2>/dev/null | wc -l | xargs -I {} echo "  ğŸ“Š Active proc entries: {}"

	@echo ""
	@echo "ğŸ” eBPF Programs:"
	$(MAKE) -C $(EBPF_DIR) status

	@echo ""
	@echo "ğŸ” System Information:"
	@echo "  ğŸ–¥ï¸ Kernel: $(shell uname -r)"
	@echo "  ğŸ—ï¸ Build directory: $(KERNEL_DIR)"
	@echo "  ğŸ“ Working directory: $(PWD)"
	@echo "  â° Build time: $(shell date)"

# Validate all modules
validate: modules
	@echo "âœ… Validating SynOS AI kernel modules..."
	@echo ""
	@for module in $(MODULES); do \
		echo "ğŸ” Validating $$module.ko..."; \
		modinfo $$module.ko | head -10; \
		echo ""; \
	done

	@echo "ğŸ” Checking module dependencies..."
	@for module in $(MODULES); do \
		echo "Dependencies for $$module:"; \
		objdump -h $$module.ko | grep -E "(\.text|\.data|\.rodata)" || echo "  No standard sections found"; \
		echo ""; \
	done

	@echo "âœ… Validation complete!"

# Development workflow - quick build and test
dev: clean modules test

# Full deployment workflow
deploy: clean modules ebpf install load test
	@echo ""
	@echo "ğŸ‰ SynOS AI-Enhanced Kernel deployment complete!"
	@echo "ğŸ§  AI consciousness and optimization systems are active"
	@echo "ğŸ›¡ï¸ Enhanced security monitoring is enabled"
	@echo "ğŸ“ Educational optimizations are ready"

# Monitor kernel messages in real-time
monitor:
	@echo "ğŸ“¡ Monitoring SynOS AI kernel messages..."
	@echo "Press Ctrl+C to stop monitoring"
	sudo dmesg -w | grep --line-buffered -i synos

# Performance benchmark
benchmark: load
	@echo "âš¡ Running SynOS AI performance benchmark..."
	@echo ""
	@echo "ğŸ“Š AI Scheduler Performance:"
	@cat /proc/synos_ai_scheduler | grep -E "(Accuracy|Predictions|Anomalies)"
	@echo ""
	@echo "ğŸ“Š AI Memory Performance:"
	@cat /proc/synos_ai_memory | grep -E "(Accuracy|Memory Saved|Leaks)"
	@echo ""
	@echo "ğŸ“Š AI I/O Performance:"
	@cat /proc/synos_ai_io | grep -E "(Cache Hit Rate|Latency Saved|Operations)"
	@echo ""
	@echo "âš¡ Benchmark complete!"

# Create debug build with extra logging
debug: ccflags-y += -DDEBUG_VERBOSE -g
debug: modules
	@echo "ğŸ› Debug build complete with verbose logging"

# Create release build optimized for performance
release: ccflags-y += -O3 -DNDEBUG
release: modules ebpf
	@echo "ğŸš€ Release build complete with performance optimizations"

# Quick educational demo
demo: load
	@echo "ğŸ“ SynOS AI-Enhanced Kernel Educational Demo"
	@echo "============================================="
	@echo ""
	@echo "ğŸ§  Consciousness System:"
	@cat /proc/synos_consciousness | head -15
	@echo ""
	@echo "ğŸ”§ AI Scheduler:"
	@cat /proc/synos_ai_scheduler | head -10
	@echo ""
	@echo "ğŸ’¾ AI Memory Manager:"
	@cat /proc/synos_ai_memory | head -10
	@echo ""
	@echo "ğŸ’¿ AI I/O Optimizer:"
	@cat /proc/synos_ai_io | head -10
	@echo ""
	@echo "ğŸ“ Demo complete! All AI systems are active and learning."

# Help system
help:
	@echo "ğŸ§  SynOS AI-Enhanced Kernel Build System"
	@echo "========================================="
	@echo ""
	@echo "ğŸ¯ Main Targets:"
	@echo "  all       - Build all kernel modules and eBPF programs"
	@echo "  modules   - Build only kernel modules"
	@echo "  ebpf      - Build only eBPF programs"
	@echo "  clean     - Remove all build artifacts"
	@echo ""
	@echo "ğŸš€ Deployment:"
	@echo "  install   - Install modules to system"
	@echo "  load      - Load all modules in correct order"
	@echo "  unload    - Unload all modules"
	@echo "  remove    - Completely remove from system"
	@echo "  deploy    - Full clean build, install, load, and test"
	@echo ""
	@echo "ğŸ§ª Testing & Validation:"
	@echo "  test      - Run comprehensive functionality tests"
	@echo "  validate  - Validate module structure and dependencies"
	@echo "  status    - Show detailed system status"
	@echo "  benchmark - Run performance benchmarks"
	@echo "  demo      - Quick educational demonstration"
	@echo ""
	@echo "ğŸ› ï¸ Development:"
	@echo "  dev       - Quick development cycle (clean, build, test)"
	@echo "  debug     - Create debug build with verbose logging"
	@echo "  release   - Create optimized release build"
	@echo "  monitor   - Monitor kernel messages in real-time"
	@echo ""
	@echo "ğŸ§  AI Components:"
	@echo "  ğŸ§  AI-Native Process Scheduler - ML-based process optimization"
	@echo "  ğŸ§  Adaptive Memory Management - Predictive memory optimization"
	@echo "  ğŸ§  AI-Powered I/O Optimization - Intelligent caching and throttling"
	@echo "  ğŸ§  Consciousness Monitoring - Neural darwinism framework"
	@echo "  ğŸ›¡ï¸ eBPF Security Framework - Real-time security monitoring"
	@echo ""
	@echo "ğŸ“– Examples:"
	@echo "  make deploy           # Full deployment"
	@echo "  make dev              # Quick development cycle"
	@echo "  make test             # Run all tests"
	@echo "  make demo             # Educational demonstration"
	@echo "  make status           # Check system status"
	@echo ""
	@echo "âš ï¸ Requirements:"
	@echo "  - Linux kernel headers"
	@echo "  - GCC/Clang compiler"
	@echo "  - Root privileges for loading modules"
	@echo "  - eBPF-capable kernel (5.0+)"

# Show build information
info:
	@echo "â„¹ï¸ SynOS AI-Enhanced Kernel Build Information"
	@echo "============================================="
	@echo ""
	@echo "ğŸ“¦ Modules to build:"
	@for module in $(MODULES); do echo "  - $$module"; done
	@echo ""
	@echo "ğŸ”§ Build configuration:"
	@echo "  Kernel directory: $(KERNEL_DIR)"
	@echo "  Working directory: $(PWD)"
	@echo "  Compiler flags: $(ccflags-y)"
	@echo ""
	@echo "ğŸ›¡ï¸ eBPF directory: $(EBPF_DIR)"
	@echo "ğŸ—ï¸ Build architecture: $(shell uname -m)"
	@echo "ğŸ–¥ï¸ Target kernel: $(shell uname -r)"

# Quick check if everything is ready for development
check:
	@echo "ğŸ” Checking SynOS AI development environment..."
	@echo ""
	@echo "âœ… Checking kernel headers..."
	@test -d $(KERNEL_DIR) && echo "  ğŸ“ Kernel headers found: $(KERNEL_DIR)" || echo "  âŒ Kernel headers missing: $(KERNEL_DIR)"
	@echo ""
	@echo "âœ… Checking compiler..."
	@which gcc >/dev/null && echo "  ğŸ”§ GCC compiler found" || echo "  âŒ GCC compiler missing"
	@which clang >/dev/null && echo "  ğŸ”§ Clang compiler found" || echo "  âŒ Clang compiler missing"
	@echo ""
	@echo "âœ… Checking eBPF tools..."
	@which bpftool >/dev/null && echo "  ğŸ›¡ï¸ bpftool found" || echo "  âŒ bpftool missing"
	@echo ""
	@echo "âœ… Checking permissions..."
	@groups | grep -q sudo && echo "  ğŸ” User has sudo access" || echo "  âŒ User lacks sudo access"
	@echo ""
	@echo "ğŸ” Environment check complete!"

# Estimate build time
estimate:
	@echo "â±ï¸ Estimated build times for SynOS AI components:"
	@echo "================================================"
	@echo ""
	@echo "ğŸ§  Consciousness Module:     ~30 seconds"
	@echo "ğŸ§  AI Scheduler Module:      ~45 seconds"
	@echo "ğŸ§  AI Memory Module:         ~60 seconds"
	@echo "ğŸ§  AI I/O Module:            ~50 seconds"
	@echo "ğŸ›¡ï¸ eBPF Programs:            ~20 seconds"
	@echo ""
	@echo "ğŸ“Š Total estimated time:     ~3-4 minutes"
	@echo "âš¡ Actual time may vary based on system performance"